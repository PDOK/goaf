<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>BGT</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
          integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous">
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css">
    <!--<![endif]-->


    <style>
        html {
            box-sizing: border-box;
            overflow: -moz-scrollbars-vertical;
            overflow-y: scroll;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            margin: 20px;
            background: #fafafa;
        }
    </style>

    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css"
          type="text/css">
    <style>
        .map {
            height: 400px;
            width: 100%;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>


</head>
<body>

<h2>Feature Collection</h2>

<h3>Returned # {{.NumberReturned}}</h3>

<h3>Links</h3>
<table class="pure-table pure-table-bordered">
    <thead>
    <tr>
        <th>Title</th>
        <th>Content-Type</th>
        <th>Relation-Type</th>
        <th>Href</th>
    </tr>
    </thead>

    <tbody>
    {{range  $i, $link := .Links}}
        <tr {{if isOdd $i}}class="pure-table-odd" {{end}}>
            <td>{{$link.Title}}</td>
            <td>{{$link.Type}}</td>
            <td>{{$link.Rel}}</td>
            <td><a href="{{$link.Href}}"> {{$link.Href}} </a></td>
        </tr>
    {{end}}
    </tbody>
</table>

<h3>Map</h3>
<div id="map" class="map"></div>
<script type="text/javascript">
    // Geldigheidsgebied van het tiling schema in RD-coÃ¶rdinaten:
    var projectionExtent = [-285401.92, 22598.08, 595401.9199999999, 903401.9199999999];
    var projection = new ol.proj.Projection({code: 'EPSG:28992', units: 'm', extent: projectionExtent});
    // Resoluties (pixels per meter) van de zoomniveaus:
    var resolutions = [3440.640, 1720.320, 860.160, 430.080, 215.040, 107.520, 53.760, 26.880, 13.440, 6.720, 3.360, 1.680, 0.840, 0.420, 0.210];
    var size = ol.extent.getWidth(projectionExtent) / 256;
    // Er zijn 15 (0 tot 14) zoomniveaus beschikbaar van de WMTS-service voor de BRT-Achtergrondkaart:
    var matrixIds = new Array(15);
    for (var z = 0; z < 15; ++z) {
        matrixIds[z] = 'EPSG:28992:' + z;
    }

    // magic
    proj4.defs('EPSG:28992', '+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +towgs84=565.417,50.3319,465.552,-0.398957,0.343988,-1.8774,4.0725 +units=m +no_defs');
    ol.proj.proj4.register(proj4);

    vectorSource = new ol.source.Vector({
        //  matrixSet: 'EPSG:28992',
        format: new ol.format.GeoJSON({featureProjection: 'EPSG:28992'}),
        projection: projection,
        loader: function (extent, resolution, prj) {
            var proj = prj.getCode();
            var url = window.location.href.replace('html', 'json');
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            var onError = function () {
                vectorSource.removeLoadedExtent(extent);
            };
            xhr.onerror = onError;
            xhr.onload = function () {
                if (xhr.status == 200) {
                    vectorSource.addFeatures(new ol.format.GeoJSON({featureProjection: 'EPSG:28992'}).readFeatures(xhr.responseText));
                    map.getView().fit(vectorSource.getExtent(), {duration: 0}, map.getSize());
                } else {
                    onError();
                }
            };
            xhr.send();
        },
    });

    var vector = new ol.layer.Vector({
        source: vectorSource
    });
    var map = new ol.Map({
        layers: [
            new ol.layer.Tile({
                opacity: 0.7,
                source: new ol.source.WMTS({
                    attributions: 'Kaartgegevens: &copy; <a href="https://www.kadaster.nl">Kadaster</a>',
                    url: 'https://geodata.nationaalgeoregister.nl/tiles/service/wmts?',
                    layer: 'brtachtergrondkaartgrijs',
                    matrixSet: 'EPSG:28992',
                    format: 'image/png',
                    projection: projection,
                    tileGrid: new ol.tilegrid.WMTS({
                        origin: ol.extent.getTopLeft(projectionExtent),
                        resolutions: resolutions,
                        matrixIds: matrixIds
                    }),
                    style: 'default',
                    wrapX: false
                })
            }),
            vector,
        ],
        target: 'map',
        controls: ol.control.defaults({
            attributionOptions: {
                collapsible: false
            }
        }),
        view: new ol.View({
            minZoom: 0,
            maxZoom: 15,
            projection: projection,
            center: [150000, 450000],
            zoom: 3
        })
    });

    function zoom2extent(event) { //the extent here should be dynamic

        alert(event)
        // var extent = vector.getExtent();
        //map.getView().fit(extent, {duration: 1590}, map.getSize());
    }
</script>

<h3>Properties</h3>

{{ if  gt .NumberReturned  0 }}

    <table class="pure-table pure-table-bordered">
        <thead>
        <tr>
            <th>ID</th>
            {{$feature :=  index .Features 0}}
            {{range  $k, $v :=  $feature.Properties}}
                <th>{{$k}}</th>
            {{end}}

        </tr>
        </thead>

        <tbody>
        {{range  $i, $feature := .Features}}
            <tr {{if isOdd $i}}class="pure-table-odd" {{end}}>
                <td>{{$feature.ID}}</td>
                {{range  $k, $v :=  $feature.Properties}}
                    <td>{{$v}}</td>
                {{end}}
            </tr>
        {{end}}
        </tbody>
    </table>

{{ else }}
    <h4>No results</h4>
{{end}}


</body>
</html>