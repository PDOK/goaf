<!DOCTYPE html>
{{$result:= index . "result"}}
{{$srsid:=  index . "srsid"}}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Feature</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
          integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous">
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css">
    <!--<![endif]-->

    <style>
        html {
            box-sizing: border-box;
            overflow: -moz-scrollbars-vertical;
            overflow-y: scroll;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            margin: 20px;
            background: #fafafa;
        }
    </style>

    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css"
          type="text/css">
    <style>
        #map {
            height: 400px;
            width: 100%;
            position: relative;
        }

        #info {
            font-size: 12px;
            z-index: 1;
            opacity: 0;
            position: absolute;
            bottom: 0;
            left: 0;
            margin: 0;
            background: rgba(0, 60, 136, 0.7);
            color: white;
            border: 0;
            transition: opacity 100ms ease-in;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>


</head>
<body>

<h2>Feature Collection</h2>

{{$feature := $result}}

<h3>Returned # {{$feature.ID}}</h3>

<h3>Links</h3>
<table class="pure-table pure-table-bordered">
    <thead>
    <tr>
        <th>Title</th>
        <th>Content-Type</th>
        <th>Relation-Type</th>
        <th>Href</th>
    </tr>
    </thead>

    <tbody>
    {{range  $i, $link := $feature.Links}}
        <tr {{if isOdd $i}}class="pure-table-odd" {{end}}>
            <td>{{$link.Title}}</td>
            <td>{{$link.Type}}</td>
            <td>{{$link.Rel}}</td>
            <td><a href="{{$link.Href}}"> {{$link.Href}} </a></td>
        </tr>
    {{end}}
    </tbody>
</table>

<h3>Map</h3>
<div id="map" class="map">
    <pre id="info"/>
</div>
<script type="text/javascript">
    // Resoluties (pixels per meter) van de zoomniveaus:
    const resolutions = new Array(20)
    const matrixIds = new Array(20)
    const projection = ol.proj.get('EPSG:3857')
    const projectionExtent = projection.getExtent()
    const size = ol.extent.getWidth(projectionExtent) / 256
    // TODO: retrieve nr of zoomlevels from service capabilities
    for (var z = 0; z < 20; ++z) {
        resolutions[z] = size / Math.pow(2, z)
        matrixIds[z] = z
    }

    vectorSource = new ol.source.Vector({
        //  matrixSet: 'EPSG:28992',
        format: new ol.format.GeoJSON({dataProjection: '{{$srsid}}', featureProjection: 'EPSG:3857'}),
        projection: projection,
        loader: function (extent, resolution, prj) {
            var proj = prj.getCode();
            var url = window.location.href.replace('html', 'json');
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            var onError = function () {
                vectorSource.removeLoadedExtent(extent);
            };
            xhr.onerror = onError;
            xhr.onload = function () {
                if (xhr.status == 200) {
                    vectorSource.addFeatures(vectorSource.getFormat().readFeatures(xhr.responseText));
                    map.getView().fit(vectorSource.getExtent(), {duration: 0}, map.getSize());
                } else {
                    onError();
                }
            };
            xhr.send();
        },
    });

    var vector = new ol.layer.Vector({
        source: vectorSource
    });
    var map = new ol.Map({
        layers: [
            new ol.layer.Tile({
                opacity: 0.7,
                source: new ol.source.WMTS({
                    attributions: 'Kaartgegevens: &copy; <a href="https://www.kadaster.nl">Kadaster</a>',
                    url: 'https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0',
                    crossOrigin: 'Anonymous',
                    layer: "grijs",
                    matrixSet: 'EPSG:3857',
                    format: 'image/png',
                    projection: projection,
                    tileGrid: new ol.tilegrid.WMTS({
                        origin: ol.extent.getTopLeft(projectionExtent),
                        resolutions: resolutions,
                        matrixIds: matrixIds
                    }),
                    style: 'default',
                    wrapX: false
                })
            }),
            vector,
        ],
        target: 'map',
        controls: ol.control.defaults({
            attributionOptions: {
                collapsible: false
            }
        }),
        view: new ol.View({
            minZoom: 1,
            maxZoom: 15,
            projection: projection,
            center: [609661.7376,6842031.2759], // fallback to approximate center NL
            zoom: 10
        })
    });

    var info = document.getElementById('info');

    function showInfo(event) {
        var features = map.getFeaturesAtPixel(event.pixel);
        if (!features) {
            info.innerText = '';
            info.style.opacity = 0;
            return;
        }
        var properties = features[0].getProperties();
        delete properties.geometry;
        info.innerText = JSON.stringify(properties, null, 2);
        info.style.opacity = 1;
    }

    map.on('pointermove', showInfo);

</script>

<h3>Properties</h3>

<table class="pure-table pure-table-bordered">
    <thead>
    <tr>
        <th>ID</th>
        {{range  $k, $v :=  $feature.Properties}}
            <th>{{$k}}</th>
        {{end}}

    </tr>
    </thead>

    <tbody>
    <tr>
        <td>{{$feature.ID}}</td>
        {{range  $k, $v :=  $feature.Properties}}
            <td>{{$v}}</td>
        {{end}}
    </tr>
    </tbody>
</table>

</body>
</html>